<!DOCTYPE html>
<html lang="en">

<head>
    <script src="_content/Blazor.Extensions.Canvas/blazor.extensions.canvas.js"></script>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>BlazorUI</title>
    <base href="./" />
    <link href="css/bootstrap/bootstrap.min.css" rel="stylesheet" />
    <link href="css/app.css" rel="stylesheet" />
    <link href="BlazorUI.styles.css" rel="stylesheet" />

    <script>
        class Utils {
            static async setImage (imageElementId, imageStream) {
                const arrayBuffer = await imageStream.arrayBuffer();
                const blob = new Blob([arrayBuffer]);
                const url = URL.createObjectURL(blob);
                document.getElementById(imageElementId).src = url;
                URL.revokeObjectURL(url);
            }

            static getPixelRatio() {
                return window.devicePixelRatio;
            }

            static writeLine(obj) {
                console.log(obj);
            }

            static disableSmoothing() {
                console.log(`set canvas to proper scaling size and canvas context imageSmoothingEnabled to false`);
                let gamePanel = document.getElementsByClassName('gamePanel')[0].getElementsByTagName('canvas')[0];
                gamePanel.style = `scale: ${1 / window.devicePixelRatio}`;
                let id = gamePanel.id;
                BlazorExtensions.Canvas2d.contexts.get(id).imageSmoothingEnabled = false;
            }
        }
        window.Utils = Utils;

        class GameAudioPlayer {
            // for cross browser compatibility
            AudioContext = window.AudioContext || window.webkitAudioContext;
            audioCtx = {};

            streams = {};

            async cacheAudio(name, stream, samples) {
                let channels = 2;
                const buf = new Float32Array(await stream.arrayBuffer());

                let arrayBuffer = new AudioBuffer({ numberOfChannels: channels, length: samples, sampleRate: this.audioCtx.sampleRate });

                for (let ch = 0; ch < channels; ch++) {
                    let buffering = arrayBuffer.getChannelData(ch);
                    for (let i = 0; i < samples; i++) {
                        buffering[i] = buf[i * 2 + (ch % 2)];
                    }
                }

                this.streams[name] = arrayBuffer;
            }

            initAudio() {
                console.log('init audio');
                // creation of audio context cannot not be done on loading file, must be done afterwards
                this.audioCtx = new AudioContext({ sampleRate: 44100 });
                console.log('audio created');
                console.log(`rate ${this.audioCtx.sampleRate}`);
                return this.audioCtx.sampleRate;
            }

            playStream(name) {
                let src = this.audioCtx.createBufferSource();
                src.buffer = this.streams[name];
                src.connect(this.audioCtx.destination);
                src.start();
            }
        }

        window.GameAudioPlayer = new GameAudioPlayer();
        console.log(`setup js ${window.GameAudioPlayer}`);
    </script>

</head >

    <body>
        <div id="app">Loading...</div>

        <div id="blazor-error-ui">
            An unhandled error has occurred.
            <a href="" class="reload">Reload</a>
            <a class="dismiss">ðŸ—™</a>
        </div>
        <script src="_framework/blazor.webassembly.js"></script>
    </body>

</html>
